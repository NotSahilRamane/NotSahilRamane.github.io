<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Pookie - Instagram Chats</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      background: #000;
      color: #fff;
      height: 100vh;
      overflow: hidden;
      overflow-x: hidden;
    }

    .container {
      display: flex;
      height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
      overflow-x: hidden;
      width: 100%;
    }

    /* Sidebar with chat list */
    .sidebar {
      width: 350px;
      background: #121212;
      border-right: 1px solid #262626;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .sidebar-header {
      padding: 20px;
      border-bottom: 1px solid #262626;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .sidebar-header h1 {
      font-size: 24px;
      font-weight: 600;
    }

    .chat-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      touch-action: pan-y; /* Allow vertical scrolling */
    }

    .chat-item {
      padding: 16px 20px;
      cursor: pointer;
      border-bottom: 1px solid #262626;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .chat-item:hover {
      background: #1a1a1a;
    }

    .chat-item.active {
      background: #1a1a1a;
    }

    .chat-avatar {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      font-weight: 600;
      flex-shrink: 0;
    }

    .profile-picture {
      flex-shrink: 0;
      border-radius: 50%;
      object-fit: cover;
    }

    .chat-info {
      flex: 1;
      min-width: 0;
    }

    .chat-name {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chat-preview {
      font-size: 14px;
      color: #a8a8a8;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* Main chat area */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #000;
      min-width: 0;
      overflow-x: hidden;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid #262626;
      display: flex;
      align-items: center;
      gap: 12px;
      background: #121212;
      justify-content: space-between;
    }

    .chat-header-left {
      display: flex;
      align-items: center;
      gap: 12px;
      flex: 1;
      min-width: 0;
    }

    .chat-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .header-button {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      width: 36px;
      height: 36px;
    }

    .header-button:hover {
      background: #262626;
    }

    .header-button svg {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .search-input {
      background: #262626;
      border: 1px solid #363636;
      border-radius: 8px;
      padding: 8px 12px;
      color: #fff;
      font-size: 14px;
      width: 200px;
      outline: none;
      transition: border-color 0.2s;
    }

    .search-input:focus {
      border-color: #0095f6;
    }

    .search-input::placeholder {
      color: #a8a8a8;
    }

    .user-view-dropdown {
      position: relative;
    }

    .user-view-menu {
      position: absolute;
      top: 100%;
      right: 0;
      margin-top: 8px;
      background: #1a1a1a;
      border: 1px solid #262626;
      border-radius: 8px;
      min-width: 200px;
      max-height: 300px;
      overflow-y: auto;
      z-index: 1000;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      display: none;
    }

    .user-view-menu.show {
      display: block;
    }

    .user-view-item {
      padding: 12px 16px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .user-view-item:hover {
      background: #262626;
    }

    .user-view-item.active {
      background: #0095f6;
      color: #fff;
    }

    .user-view-item-avatar {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .user-view-item-avatar img,
    .user-view-item-avatar > div {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* Search highlight and navigation */
    .message.search-match-message {
      opacity: 1;
    }

    .message.highlighted {
      background: rgba(0, 149, 246, 0.15);
      border-radius: 8px;
      padding: 4px;
      margin: -4px;
      animation: highlightPulse 0.5s ease;
      box-shadow: 0 0 0 2px rgba(0, 149, 246, 0.3);
    }

    @keyframes highlightPulse {
      0% { background: rgba(0, 149, 246, 0.3); }
      100% { background: rgba(0, 149, 246, 0.1); }
    }

    .message-content .search-match {
      background: rgba(0, 149, 246, 0.3);
      padding: 2px 4px;
      border-radius: 4px;
      font-weight: 600;
    }

    .search-navigation {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #1a1a1a;
      border: 1px solid #262626;
      border-radius: 24px;
      padding: 8px 16px;
      align-items: center;
      gap: 12px;
      z-index: 200;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
    }

    .search-navigation.show {
      display: flex;
    }

    .search-nav-button {
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 6px 12px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      font-size: 14px;
    }

    .search-nav-button:hover:not(:disabled) {
      background: #262626;
    }

    .search-nav-button:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .search-nav-info {
      font-size: 14px;
      color: #a8a8a8;
      padding: 0 8px;
      white-space: nowrap;
    }

    .chat-header-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 600;
      overflow: hidden;
    }

    .chat-header-name {
      font-weight: 600;
      font-size: 16px;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 0;
      width: 100%;
      -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
      touch-action: pan-y; /* Allow vertical scrolling */
    }

    .message {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      max-width: 70%;
      min-width: 0;
      width: fit-content;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message.sent {
      align-self: flex-end;
      flex-direction: row-reverse;
    }

    .message.received {
      align-self: flex-start;
    }

    .message-avatar {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      flex-shrink: 0;
      overflow: hidden;
    }

    .message-content {
      background: #262626;
      padding: 8px 12px;
      border-radius: 18px;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      line-height: 1.4;
      max-width: 100%;
      min-width: 0;
    }

    .message.sent .message-content {
      background: #0095f6;
      color: #fff;
    }

    .message.received .message-content {
      background: #262626;
      color: #fff;
    }

    .message-text {
      font-size: 14px;
      margin-bottom: 4px;
      word-wrap: break-word;
      word-break: break-word;
      overflow-wrap: break-word;
      max-width: 100%;
    }

    .message-attachment {
      margin-top: 8px;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 8px;
      max-width: 100%;
      word-break: break-word;
      overflow-wrap: break-word;
    }

    .message-attachment a {
      color: #0095f6;
      text-decoration: none;
      font-size: 12px;
      word-break: break-all;
      overflow-wrap: break-word;
      max-width: 100%;
      display: block;
    }

    .message-attachment a:hover {
      text-decoration: underline;
    }

    .message-image {
      margin-top: 8px;
      border-radius: 12px;
      overflow: hidden;
      max-width: 300px;
      width: 100%;
    }

    .message-image img {
      width: 100%;
      max-width: 100%;
      height: auto;
      display: block;
      border-radius: 12px;
      object-fit: contain;
    }

    .message-instagram-link {
      margin-top: 8px;
      max-width: 100%;
      width: 100%;
    }

    .instagram-embed-link {
      display: block;
      text-decoration: none;
      color: inherit;
      width: 100%;
    }

    .instagram-link-preview {
      display: flex;
      flex-direction: column;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: background 0.2s;
      overflow: hidden;
      max-width: 100%;
    }

    .message.sent .instagram-link-preview {
      background: rgba(255, 255, 255, 0.15);
    }

    .instagram-link-preview:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .message.sent .instagram-link-preview:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .instagram-link-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .instagram-link-icon {
      font-size: 24px;
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .instagram-link-text {
      flex: 1;
      min-width: 0;
    }

    .instagram-link-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 2px;
    }

    .instagram-link-url {
      font-size: 12px;
      color: #a8a8a8;
      word-break: break-all;
      overflow-wrap: break-word;
    }

    .instagram-link-preview-image {
      width: 100%;
      min-height: 240px;
      max-height: 360px;
      background: #1a1a1a;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      overflow: hidden;
      aspect-ratio: 1;
    }

    .instagram-link-preview-image::before {
      content: 'ðŸ“·';
      font-size: 48px;
      opacity: 0.3;
      position: absolute;
      z-index: 0;
      pointer-events: none;
    }

    .instagram-link-preview-image iframe {
      width: 100%;
      min-height: 240px;
      max-height: 360px;
      border: none;
      background: transparent;
      position: relative;
      z-index: 1;
    }

    .instagram-link-preview-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
      position: absolute;
      top: 0;
      left: 0;
      z-index: 1;
    }

    .instagram-link-preview-image .embed-fallback {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #888;
      font-size: 14px;
      position: absolute;
      z-index: 0;
    }

    .instagram-link-footer {
      padding: 8px 12px;
      font-size: 12px;
      color: #a8a8a8;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .instagram-link-footer::before {
      content: 'â–¶';
      font-size: 10px;
    }

    .message-reactions {
      margin-top: 4px;
      font-size: 12px;
      color: #a8a8a8;
    }

    .message-timestamp {
      font-size: 11px;
      color: #a8a8a8;
      margin-top: 4px;
      padding: 0 4px;
    }

    .empty-state {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #a8a8a8;
      font-size: 14px;
    }

    .load-more-indicator {
      text-align: center;
      padding: 12px;
      color: #a8a8a8;
      font-size: 12px;
    }

    .load-more-button {
      width: 100%;
      padding: 12px 20px;
      margin: 12px 0;
      background: #262626;
      border: 1px solid #363636;
      border-radius: 8px;
      color: #fff;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s, border-color 0.2s;
      text-align: center;
    }

    .load-more-button:hover {
      background: #363636;
      border-color: #464646;
    }

    .load-more-button:active {
      background: #1a1a1a;
    }

    .load-more-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Scrollbar styling */
    ::-webkit-scrollbar {
      width: 8px;
    }

    ::-webkit-scrollbar-track {
      background: #121212;
    }

    ::-webkit-scrollbar-thumb {
      background: #262626;
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #363636;
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: #a8a8a8;
    }

    /* Filter out system messages */
    .message.system {
      display: none;
    }

    /* Mobile back button */
    .back-button {
      display: none;
      background: transparent;
      border: none;
      color: #fff;
      cursor: pointer;
      padding: 8px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
      width: 40px;
      height: 40px;
      margin-right: 8px;
      -webkit-tap-highlight-color: transparent;
    }

    .back-button svg {
      width: 24px;
      height: 24px;
      stroke: currentColor;
    }

    .back-button:active {
      background: #262626;
    }

    /* Sidebar overlay for mobile */
    .sidebar-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100vh;
      height: 100dvh; /* Dynamic viewport height for mobile */
      background: rgba(0, 0, 0, 0.5);
      z-index: 999;
      opacity: 0;
      transition: opacity 0.3s ease;
      touch-action: none; /* Prevent scrolling when overlay is visible */
    }

    .sidebar-overlay.show {
      display: block;
      opacity: 1;
    }

    /* Mobile responsive styles */
    @media (max-width: 768px) {
      html, body {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
        touch-action: none; /* Prevent default touch behaviors on body */
      }

      .container {
        position: relative;
        max-width: 100%;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile */
        touch-action: pan-y; /* Allow vertical scrolling in container */
      }

      /* Sidebar - hidden by default on mobile, shown as overlay */
      .sidebar {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100vh;
        height: 100dvh; /* Dynamic viewport height for mobile */
        z-index: 1000;
        transform: translateX(-100%);
        transition: transform 0.3s ease;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.3);
        -webkit-overflow-scrolling: touch;
        touch-action: pan-y;
      }

      .sidebar.show {
        transform: translateX(0);
      }

      .sidebar-overlay {
        display: block;
        pointer-events: none; /* Don't block touches when not shown */
      }

      .sidebar-overlay.show {
        pointer-events: auto; /* Block touches when overlay is visible */
      }

      .sidebar-header {
        padding: 16px;
      }

      .sidebar-header h1 {
        font-size: 20px;
      }

      .chat-item {
        padding: 14px 16px;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .chat-item:active {
        background: #262626;
      }

      .chat-avatar {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }

      /* Chat area - full width on mobile */
      .chat-area {
        width: 100%;
        touch-action: pan-y; /* Allow vertical scrolling */
        position: relative;
        z-index: 1;
      }

      .chat-header {
        padding: 12px 16px;
        position: sticky;
        top: 0;
        z-index: 100;
      }

      .chat-header-left {
        gap: 8px;
      }

      .chat-header-name {
        font-size: 15px;
      }

      .back-button {
        display: flex;
      }

      .header-button {
        width: 40px;
        height: 40px;
        padding: 10px;
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .header-button:active {
        background: #262626;
      }

      .header-button svg {
        width: 22px;
        height: 22px;
      }

      .chat-header {
        position: relative;
      }

      .search-input {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        width: 100%;
        margin: 0;
        border-radius: 0;
        border-left: none;
        border-right: none;
        border-top: 1px solid #262626;
        padding: 12px 16px;
        font-size: 16px; /* Prevents zoom on iOS */
        z-index: 10;
      }

      .chat-header-right {
        gap: 4px;
      }

      /* User view menu - full width on mobile */
      .user-view-menu {
        position: fixed;
        top: auto;
        bottom: 0;
        left: 0;
        right: 0;
        max-height: 50vh;
        border-radius: 16px 16px 0 0;
        margin: 0;
        width: 100%;
      }

      .user-view-item {
        padding: 16px;
        min-height: 56px; /* Touch target size */
        -webkit-tap-highlight-color: transparent;
        touch-action: manipulation;
      }

      .user-view-item:active {
        background: #363636;
      }

      .user-view-item-avatar {
        width: 32px;
        height: 32px;
      }

      /* Messages container */
      .messages-container {
        padding: 12px;
        gap: 6px;
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
        touch-action: pan-y; /* Allow vertical scrolling */
        overscroll-behavior: contain; /* Prevent scroll chaining */
      }

      .message {
        max-width: 85%;
      }

      .message-content {
        padding: 10px 14px;
        font-size: 15px;
      }

      .message-text {
        font-size: 15px;
      }

      .message-avatar {
        width: 32px;
        height: 32px;
      }

      .message-image {
        max-width: 100%;
      }

      .message-image img {
        border-radius: 12px;
      }

      /* Instagram link preview - smaller on mobile */
      .instagram-link-preview-image {
        min-height: 200px;
        max-height: 300px;
      }

      .instagram-link-preview-image iframe {
        min-height: 200px;
        max-height: 300px;
      }

      /* Chat list items - larger touch targets */
      .chat-item {
        min-height: 64px;
      }

      /* Scrollbar - thinner on mobile */
      ::-webkit-scrollbar {
        width: 4px;
      }
    }

    /* Small mobile devices */
    @media (max-width: 480px) {
      .sidebar-header {
        padding: 12px;
      }

      .sidebar-header h1 {
        font-size: 18px;
      }

      .chat-header {
        padding: 10px 12px;
      }

      .chat-header-name {
        font-size: 14px;
      }

      .messages-container {
        padding: 10px;
      }

      .message {
        max-width: 90%;
      }

      .message-content {
        padding: 8px 12px;
        font-size: 14px;
      }

      .chat-item {
        padding: 12px;
      }

      .chat-avatar {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar-overlay" id="sidebarOverlay"></div>
  <div class="container">
    <!-- Sidebar -->
    <div class="sidebar">
      <div class="sidebar-header">
        <h1>Messages</h1>
      </div>
      <div class="chat-list" id="chatList">
        <div class="loading">Loading chats...</div>
      </div>
    </div>

    <!-- Main chat area -->
    <div class="chat-area">
      <div class="chat-header" id="chatHeader" style="display: none;">
        <div class="chat-header-left">
          <button class="back-button" id="backButton" title="Back to chats">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M19 12H5M12 19l-7-7 7-7"/>
            </svg>
          </button>
          <div class="chat-header-avatar" id="chatHeaderAvatar"></div>
          <div class="chat-header-name" id="chatHeaderName"></div>
        </div>
        <div class="chat-header-right">
          <div class="user-view-dropdown">
            <button class="header-button" id="userViewButton" title="Switch view">
              <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
            </button>
            <div class="user-view-menu" id="userViewMenu"></div>
          </div>
          <button class="header-button" id="searchButton" title="Search messages">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.35-4.35"></path>
            </svg>
          </button>
          <input type="text" class="search-input" id="searchInput" placeholder="Search messages..." style="display: none;">
        </div>
      </div>
      <div class="messages-container" id="messagesContainer">
        <div class="empty-state">Select a chat to view messages</div>
      </div>
      <div class="search-navigation" id="searchNavigation">
        <button class="search-nav-button" id="searchPrevButton" title="Previous match">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M15 18l-6-6 6-6"/>
          </svg>
        </button>
        <div class="search-nav-info" id="searchNavInfo"></div>
        <button class="search-nav-button" id="searchNextButton" title="Next match">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M9 18l6-6-6-6"/>
          </svg>
        </button>
        <button class="search-nav-button" id="searchCloseButton" title="Close search">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
            <path d="M18 6L6 18M6 6l12 12"/>
          </svg>
        </button>
      </div>
    </div>
  </div>

  <script>
    let chatsData = null;
    let currentChat = null;
    let currentMessages = []; // All messages in memory
    let displayedCount = 1000; // Start with last 1000 messages
    const MESSAGES_PER_LOAD = 1000; // Load 1000 more at a time
    let currentViewUser = null; // Current user perspective (null = default view)
    let searchQuery = '';
    let searchResults = []; // Array of message indices that match search (from all messages)
    let currentSearchIndex = -1; // Current highlighted search result

    // Profile picture mapping for chats
    const chatProfilePictures = {
      'hufrish': 'hufrish.png',
      'smolexoticfish': 'smolexoticfish.png'
    };

    // Profile picture mapping for individual senders
    const senderProfilePictures = {
      'HUFRISH': 'hufrish.png',
      'à¤¸à¤¾à¤¹à¥€à¤²': 'sahil.jpg', // You (Sahil)
      'à¤ªà¥à¤·à¥à¤ªà¤¾à¤‚à¤¶à¥ ðŸŒ': 'pushpanshu.png',
      'Anilesh Duraphe': 'anilesh.png'
    };

    // Load chat data
    fetch('chats_data.json')
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        chatsData = data;
        renderChatList();
      })
      .catch(error => {
        console.error('Error loading chat data:', error);
        const errorMsg = error.message || 'Unknown error';
        document.getElementById('chatList').innerHTML = `
          <div class="empty-state">
            Error loading chats<br/>
            <small style="font-size: 11px; margin-top: 8px; display: block;">${errorMsg}</small>
            <small style="font-size: 11px; margin-top: 4px; display: block;">Make sure you're running a local server or hosting this page</small>
          </div>
        `;
      });

    function getInitials(name) {
      if (!name) return '?';
      const words = name.trim().split(/\s+/);
      if (words.length >= 2) {
        return (words[0][0] + words[words.length - 1][0]).toUpperCase();
      }
      return name.substring(0, 2).toUpperCase();
    }

    function getAvatarHtml(chatKey, sender, size = 'normal', isSent = false) {
      let profilePic = null;
      
      // Priority 1: For messages, use sender-specific profile picture
      if (sender && senderProfilePictures[sender]) {
        profilePic = senderProfilePictures[sender];
      }
      // Priority 2: For chat list and header, use chat profile picture
      else if (chatKey && chatProfilePictures[chatKey]) {
        profilePic = chatProfilePictures[chatKey];
      }
      // Priority 3: For received messages without sender pic, use current chat's profile picture
      else if (sender && !isSent && currentChat && chatProfilePictures[currentChat]) {
        profilePic = chatProfilePictures[currentChat];
      }
      
      const sizeClass = size === 'small' ? '28px' : size === 'header' ? '32px' : '56px';
      
      if (profilePic) {
        return `<img src="${profilePic}" alt="${sender || chatKey || 'User'}" class="profile-picture" style="width: ${sizeClass}; height: ${sizeClass}; border-radius: 50%; object-fit: cover;" />`;
      } else {
        // Fallback to gradient with initials
        const initials = sender ? getInitials(sender) : (chatKey && chatsData && chatsData[chatKey] ? getInitials(chatsData[chatKey].name) : '?');
        return `<div class="chat-avatar" style="width: ${sizeClass}; height: ${sizeClass}; font-size: ${size === 'small' ? '12px' : size === 'header' ? '14px' : '20px'}; display: flex; align-items: center; justify-content: center;">${initials}</div>`;
      }
    }

    function getPreview(message) {
      if (!message) return 'No messages';
      if (message.message) {
        return message.message.substring(0, 30) + (message.message.length > 30 ? '...' : '');
      }
      if (message.attachments && message.attachments.length > 0) {
        return 'ðŸ“Ž Attachment';
      }
      return 'No messages';
    }

    function isSystemMessage(message) {
      const systemKeywords = [
        'liked a message',
        'reacted',
        'sent an attachment',
        'Group invitation link',
        'Participants:'
      ];
      return systemKeywords.some(keyword => 
        message.message && message.message.toLowerCase().includes(keyword.toLowerCase())
      );
    }

    function renderChatList() {
      const chatList = document.getElementById('chatList');
      chatList.innerHTML = '';

      Object.keys(chatsData).forEach(chatKey => {
        const chat = chatsData[chatKey];
        const lastMessage = chat.messages && chat.messages.length > 0 
          ? chat.messages[chat.messages.length - 1] 
          : null;
        
        const totalMessages = (chat.messages || []).length;
        console.log(`Chat "${chat.name}": ${totalMessages.toLocaleString()} total messages`);

        const chatItem = document.createElement('div');
        chatItem.className = 'chat-item';
        chatItem.onclick = () => openChat(chatKey, chat, chatItem);

        chatItem.innerHTML = `
          ${getAvatarHtml(chatKey, null, 'normal')}
          <div class="chat-info">
            <div class="chat-name">${chat.name}</div>
            <div class="chat-preview">${getPreview(lastMessage)}</div>
          </div>
        `;

        chatList.appendChild(chatItem);
      });
    }

    function isMobile() {
      return window.innerWidth <= 768;
    }

    function showSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) {
        sidebar.classList.add('show');
      }
      if (overlay && isMobile()) {
        overlay.classList.add('show');
      }
    }

    function hideSidebar() {
      const sidebar = document.querySelector('.sidebar');
      const overlay = document.getElementById('sidebarOverlay');
      if (sidebar) {
        sidebar.classList.remove('show');
      }
      if (overlay) {
        overlay.classList.remove('show');
      }
    }

    function openChat(chatKey, chat, element) {
      currentChat = chatKey;
      displayedCount = 1000; // Reset to last 1000 messages
      currentViewUser = null; // Reset view user
      searchQuery = ''; // Reset search
      document.getElementById('searchInput').value = '';
      document.getElementById('searchInput').style.display = 'none';
      
      // Hide sidebar on mobile when opening chat
      if (isMobile()) {
        hideSidebar();
      }
      
      // Update active state
      document.querySelectorAll('.chat-item').forEach(item => {
        item.classList.remove('active');
      });
      if (element) {
        element.classList.add('active');
      }

      // Filter and store all messages in memory
      currentMessages = (chat.messages || [])
        .filter(msg => !isSystemMessage(msg))
        .reverse(); // Reverse so newest is at end

      const totalMessageCount = currentMessages.length;
      console.log(`Chat "${chat.name}" has ${totalMessageCount} messages`);

      // Update header
      document.getElementById('chatHeader').style.display = 'flex';
      document.getElementById('chatHeaderAvatar').innerHTML = getAvatarHtml(chatKey, null, 'header');
      document.getElementById('chatHeaderName').textContent = chat.name;

      // Update user view menu
      updateUserViewMenu();

      // Render initial messages
      renderMessages();

      // Clear search when switching chats
      clearSearch();
    }

    function getFilteredMessages() {
      if (!currentMessages || currentMessages.length === 0) {
        return [];
      }

      let filtered = currentMessages;

      // Apply user view filter
      if (currentViewUser) {
        filtered = filtered.map(msg => {
          // Create a copy of the message with adjusted is_sent flag
          const adjustedMsg = { ...msg };
          adjustedMsg.is_sent = (msg.sender === currentViewUser);
          return adjustedMsg;
        });
      }

      // Don't filter by search - we'll highlight matches instead
      return filtered;
    }

    function renderMessages(append = false) {
      const container = document.getElementById('messagesContainer');
      
      const filteredMessages = getFilteredMessages();
      
      if (!filteredMessages || filteredMessages.length === 0) {
        if (!append) {
          container.innerHTML = '<div class="empty-state">No messages</div>';
        }
        return;
      }

      // Get messages to display (from the end, showing most recent)
      const totalMessages = filteredMessages.length;
      const startIndex = Math.max(0, totalMessages - displayedCount);
      const messagesToShow = filteredMessages.slice(startIndex);

      // If appending (loading older messages), prepend them
      if (append) {
        const previousStartIndex = Math.max(0, totalMessages - (displayedCount - MESSAGES_PER_LOAD));
        const newMessages = filteredMessages.slice(previousStartIndex, startIndex);
        
        const fragment = document.createDocumentFragment();
        newMessages.forEach((message) => {
          const messageDiv = createMessageElement(message);
          fragment.appendChild(messageDiv);
        });
        
        // Remove load more button if it exists
        const loadMoreBtn = container.querySelector('.load-more-button');
        if (loadMoreBtn) {
          loadMoreBtn.remove();
        }
        
        const firstChild = container.firstChild;
        if (firstChild) {
          container.insertBefore(fragment, firstChild);
        } else {
          container.appendChild(fragment);
        }
        
        // Add load more button at the top if there are more messages
        addLoadMoreButton();
        
        // Re-apply search highlights if active
        if (searchQuery && searchQuery.trim()) {
          setTimeout(() => {
            performSearch();
          }, 0);
        }
        
        // Check scroll position for load more button
        setTimeout(() => {
          checkScrollPosition();
        }, 0);
        return;
      }

      // Otherwise, render messages from scratch
      container.innerHTML = '';
      
      // Use document fragment for better performance
      const fragment = document.createDocumentFragment();
      messagesToShow.forEach((message) => {
        const messageDiv = createMessageElement(message);
        fragment.appendChild(messageDiv);
      });
      container.appendChild(fragment);

      // Add load more button at the top if there are more messages
      addLoadMoreButton();

      // Scroll to bottom and re-perform search if active
      setTimeout(() => {
        container.scrollTop = container.scrollHeight;
        // Re-perform search if active
        if (searchQuery && searchQuery.trim()) {
          performSearch();
        }
        // Check scroll position for load more button
        checkScrollPosition();
      }, 0);
    }

    function addLoadMoreButton() {
      const container = document.getElementById('messagesContainer');
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      
      // Remove existing button
      const existingBtn = container.querySelector('.load-more-button');
      if (existingBtn) {
        existingBtn.remove();
      }
      
      // Add button if there are more messages to load
      // Button will only be visible when scrolled to top (handled by checkScrollPosition)
      if (displayedCount < totalMessages) {
        const loadMoreBtn = document.createElement('button');
        loadMoreBtn.className = 'load-more-button';
        loadMoreBtn.textContent = 'Load older messages';
        loadMoreBtn.onclick = loadOlderMessages;
        loadMoreBtn.style.display = 'none'; // Hidden by default, shown when scrolled to top
        
        // Insert at the top
        const firstChild = container.firstChild;
        if (firstChild) {
          container.insertBefore(loadMoreBtn, firstChild);
        } else {
          container.appendChild(loadMoreBtn);
        }
      }
    }

    function checkScrollPosition() {
      const container = document.getElementById('messagesContainer');
      if (!container) return;
      
      const loadMoreBtn = container.querySelector('.load-more-button');
      if (!loadMoreBtn) return;
      
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      
      // Show button only if there are more messages AND user is scrolled to top
      if (displayedCount < totalMessages) {
        const scrollTop = container.scrollTop;
        const threshold = 50; // Show button when within 50px of top
        loadMoreBtn.style.display = scrollTop <= threshold ? 'block' : 'none';
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    function loadOlderMessages() {
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      
      if (displayedCount >= totalMessages) {
        return; // All messages already loaded
      }

      const previousScrollHeight = document.getElementById('messagesContainer').scrollHeight;
      displayedCount = Math.min(displayedCount + MESSAGES_PER_LOAD, totalMessages);
      renderMessages(true); // Append mode
      
      // Maintain scroll position after loading older messages
      requestAnimationFrame(() => {
        const container = document.getElementById('messagesContainer');
        const newScrollHeight = container.scrollHeight;
        container.scrollTop = newScrollHeight - previousScrollHeight;
        // Check scroll position for load more button
        checkScrollPosition();
      });
    }

    function createMessageElement(message) {
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${message.is_sent ? 'sent' : 'received'}`;

      // Show avatar for received messages, or for sent messages if we have a profile picture
      const showAvatar = !message.is_sent || (message.is_sent && message.sender && senderProfilePictures[message.sender]);
      const avatar = showAvatar ? `
        <div class="message-avatar">${getAvatarHtml(null, message.sender, 'small', message.is_sent)}</div>
      ` : '';

      // Handle images
      let imagesHtml = '';
      if (message.images && message.images.length > 0) {
        imagesHtml = message.images.map(img => {
          // Construct image path using folder from parsed data
          let imgPath = '';
          if (img.folder && img.path) {
            // Use folder from parsed data (most reliable)
            const folder = img.folder;
            const filename = img.path;
            // Determine chat key from folder name
            const chatKey = folder.includes('hufrish') ? 'hufrish' : 'smolexoticfish';
            // Photos are accessible from server root at /photos/
            // Use absolute path from server root (most reliable)
            const localPath = `/photos/${chatKey}/${filename}`;
            // Fallback paths
            const relativePath = `../Instagram/your_instagram_activity/messages/inbox/${folder}/photos/${filename}`;
            const absolutePath = `/Instagram/your_instagram_activity/messages/inbox/${folder}/photos/${filename}`;
            // Use local path first (most reliable)
            imgPath = localPath;
          } else if (img.path) {
            // Fallback: construct path based on current chat
            const chatFolder = currentChat === 'hufrish' ? 'hufrish_1697894724937506' : 'smolexoticfish_31077562368510029';
            // Check if path already includes full path
            if (img.path.includes('your_instagram_activity/')) {
              imgPath = `/Instagram/${img.path}`;
            } else {
              imgPath = `/Instagram/your_instagram_activity/messages/inbox/${chatFolder}/photos/${img.path}`;
            }
          }
          
          if (imgPath) {
            // Ensure we have folder and path for fallback
            const folder = img.folder || (currentChat === 'hufrish' ? 'hufrish_1697894724937506' : 'smolexoticfish_31077562368510029');
            const filename = img.path || '';
            
            // Determine chat key from folder name
            const chatKey = folder.includes('hufrish') ? 'hufrish' : 'smolexoticfish';
            // Create multiple paths to try - prioritize local photos from server root
            const localPath = `/photos/${chatKey}/${filename}`;
            const relativePath = `../Instagram/your_instagram_activity/messages/inbox/${folder}/photos/${filename}`;
            const absolutePath = `/Instagram/your_instagram_activity/messages/inbox/${folder}/photos/${filename}`;
            const pathsToTry = [localPath, relativePath, absolutePath];
            
            // Escape for JSON and HTML
            const pathsJson = JSON.stringify(pathsToTry).replace(/'/g, "\\'");
            const safeFilename = filename.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
            
            return `
              <div class="message-image">
                <img src="${relativePath}" 
                     alt="${img.alt || 'Image'}" 
                     loading="lazy"
                     data-paths='${pathsJson}'
                     data-current-index="0"
                     data-original-path="${safeFilename}"
                     onerror="
                       (function() {
                         const imgEl = this;
                         try {
                           const paths = JSON.parse(imgEl.dataset.paths || '[]');
                           const currentIdx = parseInt(imgEl.dataset.currentIndex || '0');
                           console.error('Image failed. Tried:', paths[currentIdx]);
                           console.error('Full URL:', window.location.origin + (paths[currentIdx].startsWith('/') ? paths[currentIdx] : '/' + paths[currentIdx]));
                           if (currentIdx < paths.length - 1) {
                             imgEl.dataset.currentIndex = (currentIdx + 1).toString();
                             console.log('Trying fallback:', paths[currentIdx + 1]);
                             imgEl.src = paths[currentIdx + 1];
                           } else {
                             console.error('All paths failed:', paths);
                             imgEl.style.display='none';
                             const fallback = document.createElement('div');
                             fallback.style.cssText = 'padding:20px;text-align:center;color:#888;font-size:12px;';
                             fallback.textContent = 'Image: ' + (imgEl.dataset.originalPath || 'not found');
                             if (imgEl.parentElement) {
                               imgEl.parentElement.appendChild(fallback);
                             }
                           }
                         } catch(e) {
                           console.error('Error in onerror handler:', e);
                         }
                       }).call(this);
                     " />
              </div>
            `;
          }
          return '';
        }).join('');
      }

      // Handle Instagram links - embed them like Instagram does
      let attachmentsHtml = '';
      if (message.attachments && message.attachments.length > 0) {
        attachmentsHtml = message.attachments.map(att => {
          const url = att.url;
          // Check if it's an Instagram post/reel
          if (url.includes('instagram.com')) {
            // Extract username and post type from URL
            let username = '';
            let postType = 'post';
            let displayText = '';
            
            // Try to extract username from the message text or URL
            if (att.text && att.text !== url) {
              displayText = att.text;
            }
            
            // Check if it's a reel
            if (url.includes('/reel/')) {
              postType = 'reel';
            } else if (url.includes('/p/')) {
              postType = 'post';
            }
            
            // Extract username from message if available
            const messageText = message.message || '';
            const usernameMatch = messageText.match(/@?(\w+)/);
            if (usernameMatch) {
              username = usernameMatch[1];
            }
            
            // Extract post/reel ID for embed
            let postId = '';
            let embedUrl = '';
            const postMatch = url.match(/\/(p|reel)\/([A-Za-z0-9_-]+)/);
            if (postMatch) {
              postId = postMatch[2];
              const postType = postMatch[1]; // 'p' or 'reel'
              // Create Instagram embed URL
              embedUrl = `https://www.instagram.com/${postType}/${postId}/embed/`;
            }
            
            // Generate unique ID for this embed
            const embedId = 'ig-embed-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
            
            return `
              <div class="message-instagram-link">
                <a href="${url}" target="_blank" rel="noopener" class="instagram-embed-link">
                  <div class="instagram-link-preview">
                    <div class="instagram-link-header">
                      <div class="instagram-link-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                          <path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/>
                        </svg>
                      </div>
                      <div class="instagram-link-text">
                        <div class="instagram-link-title">${displayText || (username ? `@${username}` : 'Instagram')} ${postType === 'reel' ? 'Reel' : 'Post'}</div>
                        <div class="instagram-link-url">instagram.com</div>
                      </div>
                    </div>
                    <div class="instagram-link-preview-image" id="${embedId}">
                      ${embedUrl ? `
                        <iframe src="${embedUrl}" frameborder="0" scrolling="no" allowtransparency="true" allow="encrypted-media" style="width:100%;min-height:240px;max-height:360px;border:none;overflow:hidden;" loading="lazy" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"></iframe>
                        <div class="embed-fallback" style="display:none;">Tap to view on Instagram</div>
                      ` : '<div class="embed-fallback">Tap to view on Instagram</div>'}
                    </div>
                    <div class="instagram-link-footer">View on Instagram</div>
                  </div>
                </a>
              </div>
            `;
          } else {
            return `
              <div class="message-attachment">
                <a href="${url}" target="_blank" rel="noopener">${att.text || url}</a>
              </div>
            `;
          }
        }).join('');
      }

      let reactionsHtml = '';
      if (message.reactions && message.reactions.length > 0) {
        reactionsHtml = `<div class="message-reactions">${message.reactions.join(', ')}</div>`;
      }

      // Highlight search matches in message text
      let messageTextHtml = '';
      if (message.message) {
        if (searchQuery && searchQuery.trim()) {
          messageTextHtml = highlightSearchMatches(message.message, searchQuery);
        } else {
          messageTextHtml = `<div class="message-text">${escapeHtml(message.message)}</div>`;
        }
      }

      messageDiv.innerHTML = `
        ${avatar}
        <div class="message-content">
          ${messageTextHtml}
          ${imagesHtml}
          ${attachmentsHtml}
          ${reactionsHtml}
          ${message.timestamp ? `<div class="message-timestamp">${message.timestamp}</div>` : ''}
        </div>
      `;

      return messageDiv;
    }

    // Removed loadOlderMessages - all messages are now loaded at once

    function getAllUsersInChat() {
      if (!currentMessages || currentMessages.length === 0) {
        return [];
      }
      const users = new Set();
      currentMessages.forEach(msg => {
        if (msg.sender) {
          users.add(msg.sender);
        }
      });
      return Array.from(users).sort();
    }

    function updateUserViewMenu() {
      const menu = document.getElementById('userViewMenu');
      const users = getAllUsersInChat();
      
      menu.innerHTML = '';
      
      // Add "Default View" option
      const defaultItem = document.createElement('div');
      defaultItem.className = `user-view-item ${!currentViewUser ? 'active' : ''}`;
      defaultItem.innerHTML = `
        <div class="user-view-item-avatar" style="background: linear-gradient(45deg, #f09433 0%, #e6683c 25%, #dc2743 50%, #cc2366 75%, #bc1888 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-size: 10px; font-weight: 600;">ALL</div>
        <span>Default View</span>
      `;
      defaultItem.onclick = () => {
        currentViewUser = null;
        displayedCount = 1000;
        updateUserViewMenu();
        renderMessages();
        // Close menu on mobile after selection
        if (isMobile()) {
          userViewMenu.classList.remove('show');
        }
      };
      menu.appendChild(defaultItem);
      
      // Add user options
      users.forEach(user => {
        const item = document.createElement('div');
        item.className = `user-view-item ${currentViewUser === user ? 'active' : ''}`;
        // Get avatar HTML and adjust size to 24px for menu
        let avatarHtml = getAvatarHtml(null, user, 'small');
        // Replace size in avatar HTML to match menu size
        avatarHtml = avatarHtml.replace(/width:\s*28px/g, 'width: 24px').replace(/height:\s*28px/g, 'height: 24px');
        item.innerHTML = `
          <div class="user-view-item-avatar">${avatarHtml}</div>
          <span>${escapeHtml(user)}</span>
        `;
        item.onclick = () => {
          currentViewUser = user;
          displayedCount = 1000;
          updateUserViewMenu();
          renderMessages();
          // Close menu on mobile after selection
          if (isMobile()) {
            userViewMenu.classList.remove('show');
          }
        };
        menu.appendChild(item);
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function highlightSearchMatches(text, query) {
      if (!query || !query.trim()) {
        return `<div class="message-text">${escapeHtml(text)}</div>`;
      }
      
      const escapedText = escapeHtml(text);
      const escapedQuery = escapeHtml(query);
      const regex = new RegExp(`(${escapedQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
      const highlighted = escapedText.replace(regex, '<span class="search-match">$1</span>');
      
      return `<div class="message-text">${highlighted}</div>`;
    }

    function performSearch() {
      if (!searchQuery || !searchQuery.trim()) {
        clearSearch();
        return;
      }

      const query = searchQuery.toLowerCase().trim();
      const filteredMessages = getFilteredMessages();
      
      // Search through ALL messages in memory, not just rendered ones
      searchResults = [];
      currentSearchIndex = -1;

      filteredMessages.forEach((message, index) => {
        let hasMatch = false;
        
        // Check message text
        if (message.message && message.message.toLowerCase().includes(query)) {
          hasMatch = true;
        }
        
        // Check sender name
        if (message.sender && message.sender.toLowerCase().includes(query)) {
          hasMatch = true;
        }
        
        // Check attachments
        if (message.attachments && message.attachments.some(att => 
          (att.text && att.text.toLowerCase().includes(query)) ||
          (att.url && att.url.toLowerCase().includes(query))
        )) {
          hasMatch = true;
        }
        
        if (hasMatch) {
          searchResults.push(index); // Store message index, not DOM element
        }
      });

      // Now highlight and render messages that match
      highlightSearchResults();
      
      // Update navigation UI
      updateSearchNavigation();
      
      // Jump to first result if any found
      if (searchResults.length > 0) {
        currentSearchIndex = 0;
        jumpToSearchResult(0);
      }
    }

    function highlightSearchResults() {
      const container = document.getElementById('messagesContainer');
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      const startIndex = Math.max(0, totalMessages - displayedCount);
      
      // Clear all highlights first
      const allMessages = container.querySelectorAll('.message');
      allMessages.forEach(msg => {
        msg.classList.remove('search-match-message', 'highlighted');
      });
      
      // Highlight messages that are currently rendered and match search
      searchResults.forEach(messageIndex => {
        // Check if this message is currently rendered
        if (messageIndex >= startIndex && messageIndex < totalMessages) {
          const renderedIndex = messageIndex - startIndex;
          const messageEl = allMessages[renderedIndex];
          if (messageEl) {
            messageEl.classList.add('search-match-message');
          }
        }
      });
    }

    function ensureMessageLoaded(messageIndex) {
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      const startIndex = Math.max(0, totalMessages - displayedCount);
      
      // If message is not loaded, load messages up to that point
      if (messageIndex < startIndex) {
        // Calculate how many messages we need to load
        const messagesToLoad = startIndex - messageIndex + MESSAGES_PER_LOAD;
        displayedCount = Math.min(displayedCount + messagesToLoad, totalMessages);
        renderMessages(false); // Re-render all
        return true; // Indicates we reloaded
      }
      return false; // Message already loaded
    }

    function clearSearch() {
      searchResults = [];
      currentSearchIndex = -1;
      
      const container = document.getElementById('messagesContainer');
      const messages = container.querySelectorAll('.message');
      messages.forEach(msg => {
        msg.classList.remove('search-match-message', 'highlighted');
      });

      // Remove highlights from text
      const matches = container.querySelectorAll('.search-match');
      matches.forEach(match => {
        const parent = match.parentElement;
        if (parent) {
          parent.innerHTML = escapeHtml(parent.textContent);
        }
      });

      updateSearchNavigation();
      
      // Re-render to remove search highlights from text
      if (currentMessages && currentMessages.length > 0) {
        renderMessages();
      }
    }

    function jumpToSearchResult(index) {
      if (index < 0 || index >= searchResults.length) return;

      const filteredMessages = getFilteredMessages();
      const messageIndex = searchResults[index];
      
      // Ensure the message is loaded
      const wasReloaded = ensureMessageLoaded(messageIndex);
      
      if (wasReloaded) {
        // Wait for render to complete, then jump
        setTimeout(() => {
          jumpToSearchResult(index);
        }, 100);
        return;
      }

      // Find the message element in the DOM
      const container = document.getElementById('messagesContainer');
      const totalMessages = filteredMessages.length;
      const startIndex = Math.max(0, totalMessages - displayedCount);
      const renderedIndex = messageIndex - startIndex;
      
      const allMessages = container.querySelectorAll('.message');
      const targetMessage = allMessages[renderedIndex];
      
      if (!targetMessage) return;

      // Remove previous highlight
      allMessages.forEach(msg => msg.classList.remove('highlighted'));

      // Highlight current result
      targetMessage.classList.add('highlighted', 'search-match-message');
      currentSearchIndex = index;

      // Scroll to message
      const messageTop = targetMessage.offsetTop;
      const messageHeight = targetMessage.offsetHeight;
      const containerHeight = container.clientHeight;

      // Center the message in view
      const targetScroll = messageTop - (containerHeight / 2) + (messageHeight / 2);
      container.scrollTo({
        top: targetScroll,
        behavior: 'smooth'
      });

      updateSearchNavigation();
    }

    function updateSearchNavigation() {
      const nav = document.getElementById('searchNavigation');
      const prevButton = document.getElementById('searchPrevButton');
      const nextButton = document.getElementById('searchNextButton');
      const info = document.getElementById('searchNavInfo');

      if (!searchQuery || !searchQuery.trim() || searchResults.length === 0) {
        nav.classList.remove('show');
        return;
      }

      nav.classList.add('show');
      
      const current = currentSearchIndex + 1;
      const total = searchResults.length;
      const filteredMessages = getFilteredMessages();
      const totalMessages = filteredMessages.length;
      const startIndex = Math.max(0, totalMessages - displayedCount);
      
      // Check if current result is loaded
      const currentMessageIndex = searchResults[currentSearchIndex];
      const isLoaded = currentMessageIndex >= startIndex && currentMessageIndex < totalMessages;
      
      info.textContent = `${current} of ${total}${!isLoaded ? ' (loading...)' : ''}`;

      prevButton.disabled = currentSearchIndex <= 0;
      nextButton.disabled = currentSearchIndex >= searchResults.length - 1;
    }

    function goToNextSearchResult() {
      if (currentSearchIndex < searchResults.length - 1) {
        jumpToSearchResult(currentSearchIndex + 1);
      }
    }

    function goToPrevSearchResult() {
      if (currentSearchIndex > 0) {
        jumpToSearchResult(currentSearchIndex - 1);
      }
    }

    // Removed infinite scroll handler - all messages are now loaded at once

    // Set up search functionality
    document.addEventListener('DOMContentLoaded', () => {
      const searchButton = document.getElementById('searchButton');
      const searchInput = document.getElementById('searchInput');
      
      if (searchButton && searchInput) {
        searchButton.addEventListener('click', () => {
          if (searchInput.style.display === 'none' || !searchInput.style.display) {
            searchInput.style.display = 'block';
            searchInput.focus();
          } else {
            searchInput.style.display = 'none';
            searchQuery = '';
            searchInput.value = '';
            clearSearch();
            renderMessages();
          }
        });

        let searchTimeout;
        searchInput.addEventListener('input', (e) => {
          searchQuery = e.target.value;
          
          // Clear previous timeout
          clearTimeout(searchTimeout);
          
          // Perform search after a short delay (debounce)
          searchTimeout = setTimeout(() => {
            if (searchQuery && searchQuery.trim()) {
              // Re-render messages with highlights
              renderMessages();
              // Then perform search to jump to first result
              setTimeout(() => {
                performSearch();
              }, 100);
            } else {
              clearSearch();
              renderMessages();
            }
          }, 300);
        });

        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            searchInput.style.display = 'none';
            searchQuery = '';
            searchInput.value = '';
            clearSearch();
            // Re-render to remove highlights
            if (currentMessages && currentMessages.length > 0) {
              renderMessages();
            }
          } else if (e.key === 'Enter') {
            e.preventDefault();
            if (e.shiftKey) {
              goToPrevSearchResult();
            } else {
              goToNextSearchResult();
            }
          }
        });
      }

      // Set up user view button
      const userViewButton = document.getElementById('userViewButton');
      const userViewMenu = document.getElementById('userViewMenu');
      
      if (userViewButton && userViewMenu) {
        userViewButton.addEventListener('click', (e) => {
          e.stopPropagation();
          userViewMenu.classList.toggle('show');
        });

        // Close menu when clicking outside
        document.addEventListener('click', (e) => {
          if (!userViewButton.contains(e.target) && !userViewMenu.contains(e.target)) {
            userViewMenu.classList.remove('show');
          }
        });
      }

      // Set up search navigation buttons
      const searchPrevButton = document.getElementById('searchPrevButton');
      const searchNextButton = document.getElementById('searchNextButton');
      const searchCloseButton = document.getElementById('searchCloseButton');
      
      if (searchPrevButton) {
        searchPrevButton.addEventListener('click', goToPrevSearchResult);
      }
      
      if (searchNextButton) {
        searchNextButton.addEventListener('click', goToNextSearchResult);
      }
      
      if (searchCloseButton) {
        searchCloseButton.addEventListener('click', () => {
          const searchInput = document.getElementById('searchInput');
          searchInput.style.display = 'none';
          searchQuery = '';
          searchInput.value = '';
          clearSearch();
          // Re-render to remove highlights
          if (currentMessages && currentMessages.length > 0) {
            renderMessages();
          }
        });
      }

      // Set up scroll listener for load more button
      const messagesContainer = document.getElementById('messagesContainer');
      if (messagesContainer) {
        messagesContainer.addEventListener('scroll', checkScrollPosition);
        // Also check on scroll end for better UX
        let scrollTimeout;
        messagesContainer.addEventListener('scroll', () => {
          clearTimeout(scrollTimeout);
          scrollTimeout = setTimeout(() => {
            checkScrollPosition();
          }, 100);
        });
      }

      // Set up back button for mobile
      const backButton = document.getElementById('backButton');
      if (backButton) {
        backButton.addEventListener('click', () => {
          // Hide chat header and show sidebar
          document.getElementById('chatHeader').style.display = 'none';
          document.getElementById('messagesContainer').innerHTML = '<div class="empty-state">Select a chat to view messages</div>';
          showSidebar();
        });
      }

      // Set up sidebar overlay click to close
      const sidebarOverlay = document.getElementById('sidebarOverlay');
      if (sidebarOverlay) {
        sidebarOverlay.addEventListener('click', () => {
          hideSidebar();
        });
      }

      // Show sidebar on mobile when page loads (if no chat is open)
      if (isMobile()) {
        showSidebar();
      }

      // Handle window resize
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          // If switching to desktop, ensure sidebar is visible
          if (!isMobile()) {
            const sidebar = document.querySelector('.sidebar');
            if (sidebar) {
              sidebar.classList.remove('show');
              sidebar.style.transform = '';
            }
          } else {
            // If switching to mobile and no chat is open, show sidebar
            const chatHeader = document.getElementById('chatHeader');
            if (chatHeader && chatHeader.style.display === 'none') {
              showSidebar();
            }
          }
        }, 250);
      });
    });

    // Auto-open first chat (only on desktop)
    window.addEventListener('load', () => {
      setTimeout(() => {
        if (chatsData && !isMobile()) {
          const firstChatKey = Object.keys(chatsData)[0];
          const firstChat = chatsData[firstChatKey];
          const firstChatItem = document.querySelector('.chat-item');
          openChat(firstChatKey, firstChat, firstChatItem);
        } else if (chatsData && isMobile()) {
          // On mobile, show sidebar by default
          showSidebar();
        }
      }, 100);
    });
  </script>
</body>
</html>
